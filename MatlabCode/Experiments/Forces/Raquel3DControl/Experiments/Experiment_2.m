use_waypoints = false;
use_rotation_z = false;
use_obstacles = false;
moveNdim = 3;
force_CBF = false;
use_real_CBF = true;
N = 8;
dt = 0.01;
niters = 1700;
E = 3000;
nu = 0.01;
kext = 10;
yield_stress = 210e2;
SF = 2.5;
u_sat = 1.5;
k_H = 0.5;
k_G = 0.5;
k_c = 1;
k_s = 0.5;
k_Hd = 0.8;
kCBF = 1;
cbf_alpha = 0.5;
sd = 1;
thd = 0;
p_init = [ 0.5,  0.5,  1.0;...
           0.5, -0.5,  1.0;...
          -0.5, -0.5,  1.0;...
          -0.5,  0.5,  1.0;...
           0.5,  0.5,  0.0;...
           0.5, -0.5,  0.0;...
          -0.5, -0.5,  0.0;...
          -0.5,  0.5,  0.0];
agent_destinations = [ 0.5*10,  0.5,  1.0;... % Agent 1
                           0.5, -0.5,  1.0;... % Agent 2
                          -0.5, -0.5,  1.0;... % Agent 3
                          -0.5,  0.5,  1.0;... % Agent 4
                           0.5,  0.5,  0.0;... % Agent 5
                           0.5, -0.5,  0.0;... % Agent 6
                          -0.5, -0.5,  0.0;... % Agent 7
                          -0.5,  0.5,  0.0]'...% Agent 8
                          ;
recordVideo = false;
videoPrefix = 'simulation_Exp2';


results = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', cbf_alpha,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);


% plot_Results_IndividualExperiment(results,plot_CBF_VelCorr,plot_CBF_VelDiff, plot_VelComp,plot_VonMisesMax,plot_VMStressComp)
% plot_Results_IndividualExperiment(results,true,true, true,true,true);

results_1 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 1,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);

results_5 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 5,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);


results_10 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 10,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);

results_25 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 25,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);

results_50 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 50,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);


results_75 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 75,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);


results_100 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 100,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);

results_500 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 500,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);


results_1000 = runCubeKabschExperiment('use_waypoints',use_waypoints,'use_rotation_z', use_rotation_z,...
    'use_obstacles', use_obstacles,'moveNdim',moveNdim,'force_CBF',force_CBF,'use_real_CBF',use_real_CBF,...
'N',N,'dt',dt,'niters',niters,'E',E, 'nu', nu,'kext', kext,'yield_stress', yield_stress,'SF', SF,'u_sat', u_sat,...
'k_H',k_H,'k_G',k_G,'k_c',k_c,'k_s', k_s,'k_Hd', k_Hd,'kCBF', kCBF,'cbf_alpha', 1000,'sd', sd,'thd', thd,...
'p_init', p_init,'agent_destinations',agent_destinations,'recordVideo',recordVideo,'videoPrefix',videoPrefix);

%%

% color_robots = ["#D80909", "#414FD7", "#179115", "#EE0DC8", "#CF7F04", "#727272", "#26acb1", "#9769d7", "#D80909", "#414FD7", "#179115", "#EE0DC8", "#CF7F04", "#727272", "#26acb1", "#9769d7"]; % 14 robots
% 
% figure;
% plot(max(results.vm_stresses_cbf),'Color','b','DisplayName', "α_{cbf} = 0.5", 'linewidth', 2);
% hold on;
% plot(max(results_1.vm_stresses_cbf),'Color',color_robots(1),'DisplayName', "α_{cbf} = 1", 'linewidth', 2);
% plot(max(results_5.vm_stresses_cbf),'Color',color_robots(2),'DisplayName', "α_{cbf} = 5", 'linewidth', 2);
% plot(max(results_10.vm_stresses_cbf),'Color',color_robots(3),'DisplayName', "α_{cbf} = 10", 'linewidth', 2);
% plot(max(results_25.vm_stresses_cbf),'Color',color_robots(4),'DisplayName', "α_{cbf} = 25", 'linewidth', 2);
% plot(max(results_50.vm_stresses_cbf),'Color',color_robots(5),'DisplayName', "α_{cbf} = 50", 'linewidth', 2);
% plot(max(results_75.vm_stresses_cbf),'Color',color_robots(6),'DisplayName', "α_{cbf} = 75", 'linewidth', 2);
% plot(max(results_100.vm_stresses_cbf),'Color',color_robots(7),'DisplayName', "α_{cbf} = 100", 'linewidth', 2);
% % plot(max(results_500.vm_stresses_cbf),'Color',color_robots(8),'DisplayName', "CBF - Max VMStress (alpha_500)", 'linewidth', 2);
% % plot(max(results_1000.vm_stresses_cbf),'Color',color_robots(9),'DisplayName', "CBF - Max VMStress (alpha_1000)", 'linewidth', 2);
% hold off;
% xlabel('Iteration');
% ylabel('VM Stress');
% title('Von Mises Stress Comparison');
% legend show;
% grid on;